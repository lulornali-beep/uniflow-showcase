# ğŸ—„ï¸ æ•°æ®åº“é…ç½®è¯´æ˜

## âš ï¸ é‡è¦ï¼šä¿å­˜è‰ç¨¿å’Œå‘å¸ƒåŠŸèƒ½éœ€è¦æ•°æ®åº“æƒé™é…ç½®

### é—®é¢˜

å½“ä½ åœ¨ AI æ™ºèƒ½é‡‡é›†å°ç‚¹å‡»"ä¿å­˜è‰ç¨¿"æˆ–"ç¡®è®¤å‘å¸ƒ"æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°æ•°æ®åº“æƒé™é”™è¯¯ã€‚

### è§£å†³æ–¹æ¡ˆ

éœ€è¦åœ¨ Supabase Dashboard ä¸­é…ç½® RLSï¼ˆRow Level Securityï¼‰ç­–ç•¥ï¼Œå…è®¸æ’å…¥æ•°æ®åˆ° `events` è¡¨ã€‚

---

## ğŸ“‹ é…ç½®æ­¥éª¤

### æ–¹æ³• 1: ä½¿ç”¨ Anon Keyï¼ˆæ¨èç”¨äºå¼€å‘ç¯å¢ƒï¼‰

1. **è®¿é—® Supabase Dashboard**
   - æ‰“å¼€ https://app.supabase.com
   - é€‰æ‹©é¡¹ç›®

2. **æ‰“å¼€ SQL Editor**
   - å·¦ä¾§èœå•ï¼šSQL Editor
   - ç‚¹å‡» "New query"

3. **æ‰§è¡Œä»¥ä¸‹ SQL**

```sql
-- å…è®¸ anon è§’è‰²æ’å…¥ events è¡¨
-- å¦‚æœç­–ç•¥å·²å­˜åœ¨ï¼Œä¼šæŠ¥é”™ï¼Œä½†å¯ä»¥å¿½ç•¥ï¼ˆè¯´æ˜å·²ç»é…ç½®å¥½äº†ï¼‰

-- æ–¹æ³• 1: ç›´æ¥åˆ›å»ºï¼ˆå¦‚æœå·²å­˜åœ¨ä¼šæŠ¥é”™ï¼Œå¯ä»¥å¿½ç•¥ï¼‰
CREATE POLICY "Allow anon to insert events"
    ON events
    FOR INSERT
    TO anon
    WITH CHECK (true);

-- æ–¹æ³• 2: å¦‚æœæŠ¥é”™è¯´å·²å­˜åœ¨ï¼Œå¯ä»¥å…ˆåˆ é™¤å†åˆ›å»º
-- DROP POLICY IF EXISTS "Allow anon to insert events" ON events;
-- CREATE POLICY "Allow anon to insert events"
--     ON events
--     FOR INSERT
--     TO anon
--     WITH CHECK (true);
```

4. **ç‚¹å‡» "Run" æ‰§è¡Œ**

---

### æ–¹æ³• 2: ä½¿ç”¨ Service Role Keyï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œæ›´å®‰å…¨ï¼‰

1. **è·å– Service Role Key**
   - Supabase Dashboard â†’ Settings â†’ API
   - å¤åˆ¶ `service_role` keyï¼ˆâš ï¸ ä¿å¯†ï¼Œä¸è¦æš´éœ²åˆ°å‰ç«¯ï¼‰

2. **é…ç½®ç¯å¢ƒå˜é‡**
   - ç¼–è¾‘ `admin-console/.env.local`
   - æ·»åŠ ï¼š
     ```env
     SUPABASE_SERVICE_ROLE_KEY=ä½ çš„service_role_key
     ```

3. **é…ç½® RLS ç­–ç•¥**ï¼ˆå¦‚æœä½¿ç”¨ Service Role Keyï¼Œå¯ä»¥è·³è¿‡ï¼Œå› ä¸ºå®ƒç»•è¿‡ RLSï¼‰

æˆ–è€…ï¼Œå¦‚æœæƒ³é™åˆ¶æƒé™ï¼Œå¯ä»¥åˆ›å»ºç­–ç•¥ï¼š

```sql
-- å…è®¸ service_role æ’å…¥ events è¡¨
CREATE POLICY "Allow service_role to insert events"
    ON events
    FOR INSERT
    TO service_role
    WITH CHECK (true);
```

4. **é‡å¯å¼€å‘æœåŠ¡å™¨**
   ```bash
   # åœæ­¢æœåŠ¡å™¨ï¼ˆCtrl+Cï¼‰
   npm run dev
   ```

---

## ğŸ§ª æµ‹è¯•

é…ç½®å®Œæˆåï¼Œæµ‹è¯•ä¿å­˜è‰ç¨¿å’Œå‘å¸ƒåŠŸèƒ½ï¼š

1. åœ¨ AI æ™ºèƒ½é‡‡é›†å°è¾“å…¥å†…å®¹
2. ç‚¹å‡» "AI è¯†åˆ«"
3. ç‚¹å‡» "ä¿å­˜è‰ç¨¿" æˆ– "ç¡®è®¤å‘å¸ƒ"
4. åº”è¯¥çœ‹åˆ°æˆåŠŸæç¤º

å¦‚æœé‡åˆ°é”™è¯¯ï¼Œæ£€æŸ¥ï¼š
- æ•°æ®åº“ç­–ç•¥æ˜¯å¦å·²åˆ›å»º
- Service Role Key æ˜¯å¦å·²é…ç½®ï¼ˆå¦‚æœä½¿ç”¨æ–¹æ³• 2ï¼‰
- æœåŠ¡å™¨æ˜¯å¦å·²é‡å¯

---

## ğŸ“ å½“å‰æ•°æ®åº“çŠ¶æ€

æ ¹æ®ä»£ç æ£€æŸ¥ï¼Œå½“å‰ `events` è¡¨çš„ `status` å­—æ®µæ”¯æŒï¼š
- `'active'` - å·²å‘å¸ƒï¼ˆæˆ‘ä»¬ç”¨äºè¡¨ç¤º publishedï¼‰
- `'inactive'` - æœªæ¿€æ´»ï¼ˆæˆ‘ä»¬ç”¨äºè¡¨ç¤º draftï¼‰
- `'archived'` - å·²å½’æ¡£

**æ³¨æ„**ï¼šç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥æ”¯æŒ `'draft'` å’Œ `'published'` çŠ¶æ€ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ‰©å±•æ•°æ®åº“ schemaï¼š

```sql
-- æ‰©å±• status å­—æ®µæ”¯æŒ draft å’Œ published
ALTER TABLE events 
DROP CONSTRAINT IF EXISTS events_status_check;

ALTER TABLE events 
ADD CONSTRAINT events_status_check 
CHECK (status IN ('draft', 'published', 'archived', 'expired', 'active', 'inactive'));
```

æˆ–è€…ï¼Œå¯ä»¥ä¿æŒç°çŠ¶ï¼Œä½¿ç”¨æ˜ å°„ï¼š
- `draft` â†’ `inactive`
- `published` â†’ `active`

---

## âš ï¸ é‡è¦ï¼šæ‰©å±• events è¡¨ç»“æ„

å¦‚æœä½ é‡åˆ°é”™è¯¯ `Could not find the 'published_at' column`ï¼Œéœ€è¦å…ˆæ‰©å±• `events` è¡¨ç»“æ„ã€‚

### è§£å†³æ–¹æ¡ˆ

æ‰§è¡Œä»¥ä¸‹ SQL è„šæœ¬æ·»åŠ ç¼ºå¤±çš„åˆ—ï¼š

```sql
-- æ·»åŠ  published_at åˆ—
ALTER TABLE events 
ADD COLUMN IF NOT EXISTS published_at TIMESTAMPTZ;
```

å®Œæ•´çš„æ‰©å±•è„šæœ¬è¯·å‚è€ƒï¼š`admin-console/scripts/extend_events_table.sql`

æ‰§è¡Œæ­¥éª¤ï¼š
1. è®¿é—® Supabase Dashboard â†’ SQL Editor
2. æ‰“å¼€æˆ–åˆ›å»ºæ–°çš„ SQL æŸ¥è¯¢
3. å¤åˆ¶å¹¶æ‰§è¡Œ `extend_events_table.sql` ä¸­çš„ SQL
4. åˆ·æ–°æµè§ˆå™¨é¡µé¢ï¼Œé‡æ–°æµ‹è¯•ä¿å­˜/å‘å¸ƒåŠŸèƒ½

---

**æœ€åæ›´æ–°**ï¼š2025å¹´12æœˆ
